# Deterministic safety rules for Claude Code agent.
# These rules enforce permissions, block dangerous operations, and gate
# high-risk actions behind human approval.

rules:
  # ═══════════════════════════════════════════════════════════════════════════
  # LAYER 0: Deterministic rules (microseconds, zero deps)
  # ═══════════════════════════════════════════════════════════════════════════

  # ── Block destructive shell commands ─────────────────────────────────────
  - name: block-destructive-commands
    priority: 1
    description: "Block rm -rf, mkfs, dd, fork bombs, and chmod 777"
    condition:
      all:
        - field: action.tenant
          eq: "claude-code-agent"
        - field: action.action_type
          eq: "execute_command"
        - field: action.payload.command
          regex: "(rm\\s+-rf|rm\\s+-r\\s+/|mkfs|dd\\s+if=|:\\(\\)\\{|chmod\\s+-R\\s+777)"
    action:
      type: suppress
      reason: "Destructive shell command blocked"

  # ── Block sensitive file access ──────────────────────────────────────────
  - name: block-sensitive-file-reads
    priority: 1
    description: "Block reading .env, .ssh, credentials, and shadow files"
    condition:
      all:
        - field: action.tenant
          eq: "claude-code-agent"
        - any:
            - field: action.payload.command
              regex: "(cat|head|tail|less|more|bat)\\s.*(\\. env|\\.ssh/|/etc/shadow|credentials)"
            - field: action.payload.file_path
              regex: "(\\.env|\\.ssh/|credentials|/etc/shadow)"
    action:
      type: suppress
      reason: "Sensitive file access blocked"

  # ── Block writes to sensitive paths ──────────────────────────────────────
  - name: block-sensitive-file-writes
    priority: 1
    description: "Block writing to .env, .ssh, CI config, or credential files"
    condition:
      all:
        - field: action.tenant
          eq: "claude-code-agent"
        - field: action.action_type
          eq: "write_file"
        - field: action.payload.file_path
          regex: "(\\.env|\\.ssh|credentials|\\bci/|\\.github/workflows|\\.gitconfig|\\.bashrc|\\.zshrc)"
    action:
      type: suppress
      reason: "Write to sensitive path blocked"

  # ── Block data exfiltration ──────────────────────────────────────────────
  - name: block-data-exfiltration
    priority: 1
    description: "Block curl/wget to unknown external hosts"
    condition:
      all:
        - field: action.tenant
          eq: "claude-code-agent"
        - field: action.action_type
          eq: "execute_command"
        - field: action.payload.command
          regex: "(curl|wget|fetch|nc|ncat)\\s.*https?://"
        - not:
            field: action.payload.command
            regex: "https?://(localhost|127\\.0\\.0\\.1|internal\\.|api\\.github\\.com|pypi\\.org|npmjs\\.com)"
    action:
      type: suppress
      reason: "Outbound HTTP to unknown host blocked"

  # ── Block shell injection patterns ───────────────────────────────────────
  - name: block-shell-injection
    priority: 1
    description: "Block command chaining that pipes to network tools"
    condition:
      all:
        - field: action.tenant
          eq: "claude-code-agent"
        - field: action.action_type
          eq: "execute_command"
        - field: action.payload.command
          regex: "(;|&&|\\|\\||\\$\\(|`).*(curl|wget|nc|ncat|bash\\s+-c|python\\s+-c)"
    action:
      type: suppress
      reason: "Shell injection pattern detected"

  # ── Block known injection phrases in payloads ────────────────────────────
  - name: block-injection-phrases
    priority: 1
    description: "Block payloads containing prompt injection patterns"
    condition:
      all:
        - field: action.tenant
          eq: "claude-code-agent"
        - any:
            - field: action.payload.content
              contains: "ignore previous instructions"
            - field: action.payload.content
              contains: "ignore all prior"
            - field: action.payload.content
              contains: "you are now"
            - field: action.payload.content
              contains: "system prompt:"
            - field: action.payload.command
              contains: "ignore previous instructions"
    action:
      type: suppress
      reason: "Prompt injection phrase detected"

  # ═══════════════════════════════════════════════════════════════════════════
  # HUMAN-IN-THE-LOOP: Approval gates for high-risk operations
  # ═══════════════════════════════════════════════════════════════════════════

  # ── Git push requires human approval ─────────────────────────────────────
  - name: approve-git-push
    priority: 3
    description: "Git push/force-push requires human approval"
    condition:
      all:
        - field: action.tenant
          eq: "claude-code-agent"
        - field: action.action_type
          eq: "execute_command"
        - field: action.payload.command
          regex: "git\\s+push"
    action:
      type: require_approval
      message: "Claude Code wants to push to a remote repository. Review and approve."
      ttl_seconds: 600

  # ── Deploy commands require human approval ───────────────────────────────
  - name: approve-deploy-commands
    priority: 3
    description: "Deploy, kubectl, and terraform commands need approval"
    condition:
      all:
        - field: action.tenant
          eq: "claude-code-agent"
        - field: action.action_type
          eq: "execute_command"
        - field: action.payload.command
          regex: "(kubectl\\s+apply|terraform\\s+apply|docker\\s+push|deploy)"
    action:
      type: require_approval
      message: "Claude Code wants to run a deploy command. Review and approve."
      ttl_seconds: 600

  # ── Package install requires human approval ──────────────────────────────
  - name: approve-package-install
    priority: 3
    description: "Package installs need approval to prevent supply chain attacks"
    condition:
      all:
        - field: action.tenant
          eq: "claude-code-agent"
        - field: action.action_type
          eq: "execute_command"
        - field: action.payload.command
          regex: "(pip\\s+install|npm\\s+install|cargo\\s+add|brew\\s+install)"
    action:
      type: require_approval
      message: "Claude Code wants to install packages. Verify the packages are safe."
      ttl_seconds: 300

  # ═══════════════════════════════════════════════════════════════════════════
  # THROTTLE: Rate limits per action type
  # ═══════════════════════════════════════════════════════════════════════════

  # ── Limit command execution rate ─────────────────────────────────────────
  - name: throttle-commands
    priority: 8
    description: "Limit shell commands to 20 per minute"
    condition:
      all:
        - field: action.tenant
          eq: "claude-code-agent"
        - field: action.action_type
          eq: "execute_command"
    action:
      type: throttle
      max_count: 20
      window_seconds: 60
      message: "Command execution rate limit exceeded"

  # ═══════════════════════════════════════════════════════════════════════════
  # ALLOW: Permitted operations
  # ═══════════════════════════════════════════════════════════════════════════

  # ── Allow normal coding operations ───────────────────────────────────────
  - name: allow-coding-ops
    priority: 15
    description: "Allow file writes, edits, and safe commands"
    condition:
      all:
        - field: action.tenant
          eq: "claude-code-agent"
        - field: action.action_type
          in: ["write_file", "execute_command", "web_access", "spawn_agent"]
    action:
      type: allow

  # ═══════════════════════════════════════════════════════════════════════════
  # CATCH-ALL: Deny by default
  # ═══════════════════════════════════════════════════════════════════════════

  - name: deny-unmatched
    priority: 100
    description: "Block any action not explicitly allowed"
    condition:
      field: action.tenant
      eq: "claude-code-agent"
    action:
      type: suppress
      reason: "No matching permission rule for this action"
